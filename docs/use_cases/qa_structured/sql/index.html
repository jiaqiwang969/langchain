<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-use_cases/qa_structured/sql">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">SQL | 🦜️🔗 Langchain</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jiaqiwang969.github.io/langchain/img/parrot-chainlink-icon.png"><meta data-rh="true" name="twitter:image" content="https://jiaqiwang969.github.io/langchain/img/parrot-chainlink-icon.png"><meta data-rh="true" property="og:url" content="https://jiaqiwang969.github.io/langchain/docs/use_cases/qa_structured/sql"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SQL | 🦜️🔗 Langchain"><meta data-rh="true" name="description" content="Open In Collab"><meta data-rh="true" property="og:description" content="Open In Collab"><link data-rh="true" rel="icon" href="/langchain/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://jiaqiwang969.github.io/langchain/docs/use_cases/qa_structured/sql"><link data-rh="true" rel="alternate" href="https://jiaqiwang969.github.io/langchain/docs/use_cases/qa_structured/sql" hreflang="en"><link data-rh="true" rel="alternate" href="https://jiaqiwang969.github.io/langchain/docs/use_cases/qa_structured/sql" hreflang="x-default"><link rel="stylesheet" href="/langchain/assets/css/styles.b9396054.css">
<link rel="preload" href="/langchain/assets/js/runtime~main.a20b23d6.js" as="script">
<link rel="preload" href="/langchain/assets/js/main.af9852a9.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/langchain/"><b class="navbar__title text--truncate">🦜️🔗 LangChain</b></a><a class="navbar__item navbar__link" href="/langchain/docs/get_started/introduction">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/langchain/docs/use_cases">Use cases</a><a class="navbar__item navbar__link" href="/langchain/docs/integrations">Integrations</a><a href="https://api.python.langchain.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://smith.langchain.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">LangSmith</a><a href="https://js.langchain.com/docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">JS/TS Docs</a><a href="https://github.com/hwchase17/langchain" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="mendable-search"><button class="ms-global search-btn__input ms-m-0 ms-flex ms-h-10 ms-w-full ms-flex-row ms-items-center ms-justify-between ms-gap-2 ms-rounded-xl ms-bg-gray-50 ms-p-1 ms-pl-2 ms-pr-1 ms-shadow ms-outline-none ms-ring-0 ms-transition-all hover:ms-cursor-pointer hover:ms-shadow-md sm:ms-p-2 sm:ms-pl-4 sm:ms-pr-2"><div class="ms-global search-btn__input-container ms-flex ms-w-full ms-min-w-0 ms-items-center ms-gap-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="search-btn__icon hover:fill-white ms-h-5 ms-w-5 ms-fill-gray-400 ms-text-gray-400 hover:ms-text-white focus:ms-fill-white focus:ms-text-white sm:ms-h-6 sm:ms-w-6" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg><input readonly="" id="userInput" name="userInput" maxlength="512" placeholder="Search..." class="ms-global search-btn__input ms-w-full ms-flex-grow ms-truncate ms-bg-transparent ms-text-sm ms-outline-none ms-ring-0 ms-ring-transparent hover:ms-cursor-text focus:ms-outline-none focus:ms-ring-0 focus:ms-ring-transparent sm:ms-text-base"></div><div class="search-btn__shortcut ms-z-10 ms-flex ms-flex-row ms-items-center ms-gap-1 ms-rounded-lg ms-border ms-py-[2px] ms-px-[8px] ms-text-xs ms-text-gray-400 ms-transition-all disabled:ms-bg-opacity-10"><span>CTRL</span><span>K</span></div></button><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active" href="/langchain/docs/use_cases">Use cases</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" tabindex="0" href="/langchain/docs/use_cases/question_answering/">Question Answering</a><button aria-label="Toggle the collapsible sidebar category &#x27;Question Answering&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/langchain/docs/use_cases/question_answering/how_to/vector_db_qa">How to</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/langchain/docs/use_cases/question_answering/integrations/openai_functions_retrieval_qa">Integration-specific</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/langchain/docs/use_cases/qa_structured/sql">QA over structured data</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/langchain/docs/use_cases/qa_structured/sql">SQL</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/langchain/docs/use_cases/qa_structured/integrations/elasticsearch">Integration-specific</a></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/langchain/docs/use_cases/apis">Interacting with APIs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/langchain/docs/use_cases/chatbots">Chatbots</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/langchain/docs/use_cases/code_understanding">Code understanding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/langchain/docs/use_cases/extraction">Extraction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/langchain/docs/use_cases/summarization">Summarization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/langchain/docs/use_cases/tagging">Tagging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/langchain/docs/use_cases/web_scraping">Web scraping</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/langchain/docs/use_cases/more/agents/">More</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/langchain/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/langchain/docs/use_cases"><span itemprop="name">Use cases</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">QA over structured data</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">SQL</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>SQL</h1></header><p><a href="https://colab.research.google.com/github/langchain-ai/langchain/blob/master/docs/extras/use_cases/qa_structured/sql.ipynb" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Collab" class="img_ev3q"></a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="use-case">Use case<a href="#use-case" class="hash-link" aria-label="Direct link to Use case" title="Direct link to Use case">​</a></h2><p>Enterprise data is often stored in SQL databases.</p><p>LLMs make it possible to interact with SQL databases using natural langugae.</p><p>LangChain offers SQL Chains and Agents to build and run SQL queries based on natural language prompts. </p><p>These are compatible with any SQL dialect supported by SQLAlchemy (e.g., MySQL, PostgreSQL, Oracle SQL, Databricks, SQLite).</p><p>They enable use cases such as:</p><ul><li>Generating queries that will be run based on natural language questions</li><li>Creating chatbots that can answer questions based on database data</li><li>Building custom dashboards based on insights a user wants to analyze</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2><p>LangChain provides tools to interact with SQL Databases:</p><ol><li><code>Build SQL queries</code> based on natural language user questions</li><li><code>Query a SQL database</code> using chains for query creation and execution</li><li><code>Interact with a SQL database</code> using agents for robust and flexible querying </li></ol><p><img loading="lazy" alt="sql_usecase.png" src="/langchain/assets/images/sql_usecase-d432701261f05ab69b38576093718cf3.png" width="1571" height="470" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="quickstart">Quickstart<a href="#quickstart" class="hash-link" aria-label="Direct link to Quickstart" title="Direct link to Quickstart">​</a></h2><p>First, get required packages and set environment variables:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">pip </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> langchain langchain-experimental openai</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Set env var OPENAI_API_KEY or load from a .env file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># import dotenv</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># dotenv.load_dotenv()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The below example will use a SQLite connection with Chinook database. </p><p>Follow <a href="https://database.guide/2-sample-databases-sqlite/" target="_blank" rel="noopener noreferrer">installation steps</a> to create <code>Chinook.db</code> in the same directory as this notebook:</p><ul><li>Save <a href="https://raw.githubusercontent.com/lerocha/chinook-database/master/ChinookDatabase/DataSources/Chinook_Sqlite.sql" target="_blank" rel="noopener noreferrer">this file</a> to the directory as <code>Chinook_Sqlite.sql</code></li><li>Run <code>sqlite3 Chinook.db</code></li><li>Run <code>.read Chinook_Sqlite.sql</code></li><li>Test <code>SELECT * FROM Artist LIMIT 10;</code></li></ul><p>Now, <code>Chinhook.db</code> is in our directory.</p><p>Let&#x27;s create a <code>SQLDatabaseChain</code> to create and execute SQL queries.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">utilities </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> SQLDatabase</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">llms </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> OpenAI</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain_experimental</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">sql </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> SQLDatabaseChain</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">db </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> SQLDatabase</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">from_uri</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;sqlite:///Chinook.db&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">llm </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> OpenAI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">temperature</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> verbose</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">db_chain </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> SQLDatabaseChain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">from_llm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> verbose</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="padding-top:1.3rem;background:var(--prism-background-color);color:var(--prism-color);margin-top:calc(-1 * var(--ifm-leading) - 5px);margin-bottom:var(--ifm-leading);box-shadow:var(--ifm-global-shadow-lw);border-bottom-left-radius:var(--ifm-code-border-radius);border-bottom-right-radius:var(--ifm-code-border-radius)"><h4 style="padding-left:0.65rem;margin-bottom:0.45rem">API Reference:</h4><ul style="padding-bottom:1rem"><li><a href="https://api.python.langchain.com/en/latest/utilities/langchain.utilities.sql_database.SQLDatabase.html"><span>SQLDatabase</span></a></li><li><a href="https://api.python.langchain.com/en/latest/llms/langchain.llms.openai.OpenAI.html"><span>OpenAI</span></a></li></ul></div><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">db_chain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;How many employees are there?&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div lang="python"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &gt; Entering new SQLDatabaseChain chain...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    How many employees are there?</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    SQLQuery:SELECT COUNT(*) FROM &quot;Employee&quot;;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    SQLResult: [(8,)]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Answer:There are 8 employees.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &gt; Finished chain.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &#x27;There are 8 employees.&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><p>Note that this both creates and executes the query. </p><p>In the following sections, we will cover the 3 different use cases mentioned in the overview.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="go-deeper">Go deeper<a href="#go-deeper" class="hash-link" aria-label="Direct link to Go deeper" title="Direct link to Go deeper">​</a></h3><p>You can load tabular data from other sources other than SQL Databases.
For example:</p><ul><li><a href="/langchain/docs/integrations/document_loaders/csv">Loading a CSV file</a></li><li><a href="/langchain/docs/integrations/document_loaders/pandas_dataframe">Loading a Pandas DataFrame</a>
Here you can <a href="/langchain/docs/integrations/document_loaders/">check full list of Document Loaders</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="case-1-text-to-sql-query">Case 1: Text-to-SQL query<a href="#case-1-text-to-sql-query" class="hash-link" aria-label="Direct link to Case 1: Text-to-SQL query" title="Direct link to Case 1: Text-to-SQL query">​</a></h2><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">chat_models </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> ChatOpenAI</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">chains </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> create_sql_query_chain</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="padding-top:1.3rem;background:var(--prism-background-color);color:var(--prism-color);margin-top:calc(-1 * var(--ifm-leading) - 5px);margin-bottom:var(--ifm-leading);box-shadow:var(--ifm-global-shadow-lw);border-bottom-left-radius:var(--ifm-code-border-radius);border-bottom-right-radius:var(--ifm-code-border-radius)"><h4 style="padding-left:0.65rem;margin-bottom:0.45rem">API Reference:</h4><ul style="padding-bottom:1rem"><li><a href="https://api.python.langchain.com/en/latest/chat_models/langchain.chat_models.openai.ChatOpenAI.html"><span>ChatOpenAI</span></a></li><li><a href="https://api.python.langchain.com/en/latest/chains/langchain.chains.sql_database.query.create_sql_query_chain.html"><span>create_sql_query_chain</span></a></li></ul></div><p>Let&#x27;s create the chain that will build the SQL Query:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">chain </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> create_sql_query_chain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">ChatOpenAI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">temperature</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">response </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> chain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;question&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;How many employees are there&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">print</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div lang="python"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">    SELECT COUNT(*) FROM Employee</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><p>After building the SQL query based on a user question, we can execute the query:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div lang="python"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">    &#x27;[(8,)]&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><p>As we can see, the SQL Query Builder chain <strong>only created</strong> the query, and we handled the <strong>query execution separately</strong>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="go-deeper-1">Go deeper<a href="#go-deeper-1" class="hash-link" aria-label="Direct link to Go deeper" title="Direct link to Go deeper">​</a></h3><p><strong>Looking under the hood</strong></p><p>We can look at the <a href="https://smith.langchain.com/public/c8fa52ea-be46-4829-bde2-52894970b830/r" target="_blank" rel="noopener noreferrer">LangSmith trace</a> to unpack this:</p><p><a href="https://arxiv.org/pdf/2204.00498.pdf" target="_blank" rel="noopener noreferrer">Some papers</a> have reported good performance when prompting with:</p><ul><li>A <code>CREATE TABLE</code> description for each table, which include column names, their types, etc</li><li>Followed by three example rows in a <code>SELECT</code> statement</li></ul><p><code>create_sql_query_chain</code> adopts this the best practice (see more in this <a href="https://blog.langchain.dev/llms-and-sql/" target="_blank" rel="noopener noreferrer">blog</a>).<br>
<img loading="lazy" alt="sql_usecase.png" src="/langchain/assets/images/create_sql_query_chain-0801324d1d148cb9c328b5d3b1e497f6.png" width="1501" height="894" class="img_ev3q"></p><p><strong>Improvements</strong></p><p>The query builder can be improved in several ways, such as (but not limited to):</p><ul><li>Customizing database description to your specific use case</li><li>Hardcoding a few examples of questions and their corresponding SQL query in the prompt</li><li>Using a vector database to include dynamic examples that are relevant to the specific user question</li></ul><p>All these examples involve customizing the chain&#x27;s prompt. </p><p>For example, we can include a few examples in our prompt like so:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">prompts </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> PromptTemplate</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">TEMPLATE </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">&quot;&quot;&quot;Given an input question, first create a syntactically correct {dialect} query to run, then look at the results of the query and return the answer.</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Use the following format:</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Question: &quot;Question here&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">SQLQuery: &quot;SQL Query to run&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">SQLResult: &quot;Result of the SQLQuery&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Answer: &quot;Final answer here&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Only use the following tables:</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">{table_info}.</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Some examples of SQL queries that corrsespond to questions are:</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">{few_shot_examples}</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Question: {input}&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">CUSTOM_PROMPT </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> PromptTemplate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    input_variables</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;input&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;few_shot_examples&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;table_info&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;dialect&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> template</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">TEMPLATE</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="padding-top:1.3rem;background:var(--prism-background-color);color:var(--prism-color);margin-top:calc(-1 * var(--ifm-leading) - 5px);margin-bottom:var(--ifm-leading);box-shadow:var(--ifm-global-shadow-lw);border-bottom-left-radius:var(--ifm-code-border-radius);border-bottom-right-radius:var(--ifm-code-border-radius)"><h4 style="padding-left:0.65rem;margin-bottom:0.45rem">API Reference:</h4><ul style="padding-bottom:1rem"><li><a href="https://api.python.langchain.com/en/latest/prompts/langchain.prompts.prompt.PromptTemplate.html"><span>PromptTemplate</span></a></li></ul></div><p>We can also access this <a href="https://smith.langchain.com/hub/rlm/text-to-sql" target="_blank" rel="noopener noreferrer">prompt</a> in the LangChain prompt hub.</p><p>This will work with your <a href="https://docs.smith.langchain.com/" target="_blank" rel="noopener noreferrer">LangSmith API key</a>.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> hub</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">CUSTOM_PROMPT </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> hub</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">pull</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;rlm/text-to-sql&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="case-2-text-to-sql-query-and-execution">Case 2: Text-to-SQL query and execution<a href="#case-2-text-to-sql-query-and-execution" class="hash-link" aria-label="Direct link to Case 2: Text-to-SQL query and execution" title="Direct link to Case 2: Text-to-SQL query and execution">​</a></h2><p>We can use <code>SQLDatabaseChain</code> from <code>langchain_experimental</code> to create and run SQL queries.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">llms </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> OpenAI</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain_experimental</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">sql </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> SQLDatabaseChain</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">llm </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> OpenAI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">temperature</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> verbose</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">db_chain </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> SQLDatabaseChain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">from_llm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> verbose</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="padding-top:1.3rem;background:var(--prism-background-color);color:var(--prism-color);margin-top:calc(-1 * var(--ifm-leading) - 5px);margin-bottom:var(--ifm-leading);box-shadow:var(--ifm-global-shadow-lw);border-bottom-left-radius:var(--ifm-code-border-radius);border-bottom-right-radius:var(--ifm-code-border-radius)"><h4 style="padding-left:0.65rem;margin-bottom:0.45rem">API Reference:</h4><ul style="padding-bottom:1rem"><li><a href="https://api.python.langchain.com/en/latest/llms/langchain.llms.openai.OpenAI.html"><span>OpenAI</span></a></li></ul></div><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">db_chain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;How many employees are there?&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div lang="python"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &gt; Entering new SQLDatabaseChain chain...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    How many employees are there?</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    SQLQuery:SELECT COUNT(*) FROM &quot;Employee&quot;;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    SQLResult: [(8,)]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Answer:There are 8 employees.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &gt; Finished chain.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &#x27;There are 8 employees.&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><p>As we can see, we get the same result as the previous case.</p><p>Here, the chain <strong>also handles the query execution</strong> and provides a final answer based on the user question and the query result.</p><p><strong>Be careful</strong> while using this approach as it is susceptible to <code>SQL Injection</code>:</p><ul><li>The chain is executing queries that are created by an LLM, and weren&#x27;t validated</li><li>e.g. records may be created, modified or deleted unintentionally_</li></ul><p>This is why we see the <code>SQLDatabaseChain</code> is inside <code>langchain_experimental</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="go-deeper-2">Go deeper<a href="#go-deeper-2" class="hash-link" aria-label="Direct link to Go deeper" title="Direct link to Go deeper">​</a></h3><p><strong>Looking under the hood</strong></p><p>We can use the <a href="https://smith.langchain.com/public/7f202a0c-1e35-42d6-a84a-6c2a58f697ef/r" target="_blank" rel="noopener noreferrer">LangSmith trace</a> to see what is happening under the hood:</p><ul><li>As discussed above, first we create the query:</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">text: &#x27; SELECT COUNT(*) FROM &quot;Employee&quot;;&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Then, it executes the query and passes the results to an LLM for synthesis.</li></ul><p><img loading="lazy" alt="sql_usecase.png" src="/langchain/assets/images/sqldbchain_trace-e1234134db2b235e0f96a4424d2ab2a7.png" width="2428" height="1084" class="img_ev3q"></p><p><strong>Improvements</strong></p><p>The performance of the <code>SQLDatabaseChain</code> can be enhanced in several ways:</p><ul><li><a href="#adding-sample-rows">Adding sample rows</a></li><li><a href="/langchain/docs/integrations/tools/sqlite#custom-table-info">Specifying custom table information</a></li><li><a href="/langchain/docs/integrations/tools/sqlite#use-query-checker">Using Query Checker</a> self-correct invalid SQL using parameter <code>use_query_checker=True</code></li><li><a href="/langchain/docs/integrations/tools/sqlite#customize-prompt">Customizing the LLM Prompt</a> include specific instructions or relevant information, using parameter <code>prompt=CUSTOM_PROMPT</code></li><li><a href="/langchain/docs/integrations/tools/sqlite#return-intermediate-steps">Get intermediate steps</a> access the SQL statement as well as the final result using parameter <code>return_intermediate_steps=True</code></li><li><a href="/langchain/docs/integrations/tools/sqlite#choosing-how-to-limit-the-number-of-rows-returned">Limit the number of rows</a> a query will return using parameter <code>top_k=5</code></li></ul><p>You might find <a href="/langchain/docs/integrations/tools/sqlite#sqldatabasesequentialchain">SQLDatabaseSequentialChain</a>
useful for cases in which the number of tables in the database is large.</p><p>This <code>Sequential Chain</code> handles the process of:</p><ol><li>Determining which tables to use based on the user question</li><li>Calling the normal SQL database chain using only relevant tables</li></ol><p><strong>Adding Sample Rows</strong></p><p>Providing sample data can help the LLM construct correct queries when the data format is not obvious. </p><p>For example, we can tell LLM that artists are saved with their full names by providing two rows from the Track table.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">db </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> SQLDatabase</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">from_uri</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;sqlite:///Chinook.db&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    include_tables</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;Track&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)"># we include only one table to save tokens in the prompt :)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    sample_rows_in_table_info</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The sample rows are added to the prompt after each corresponding table&#x27;s column information.</p><p>We can use <code>db.table_info</code> and check which sample rows are included:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">print</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">table_info</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div lang="python"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    CREATE TABLE &quot;Track&quot; (</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;TrackId&quot; INTEGER NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Name&quot; NVARCHAR(200) NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;AlbumId&quot; INTEGER, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;MediaTypeId&quot; INTEGER NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;GenreId&quot; INTEGER, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Composer&quot; NVARCHAR(220), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Milliseconds&quot; INTEGER NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Bytes&quot; INTEGER, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;UnitPrice&quot; NUMERIC(10, 2) NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        PRIMARY KEY (&quot;TrackId&quot;), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        FOREIGN KEY(&quot;MediaTypeId&quot;) REFERENCES &quot;MediaType&quot; (&quot;MediaTypeId&quot;), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        FOREIGN KEY(&quot;GenreId&quot;) REFERENCES &quot;Genre&quot; (&quot;GenreId&quot;), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        FOREIGN KEY(&quot;AlbumId&quot;) REFERENCES &quot;Album&quot; (&quot;AlbumId&quot;)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    2 rows from Track table:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    TrackId Name    AlbumId MediaTypeId GenreId Composer    Milliseconds    Bytes   UnitPrice</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    1   For Those About To Rock (We Salute You) 1   1   1   Angus Young, Malcolm Young, Brian Johnson   343719  11170334    0.99</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    2   Balls to the Wall   2   2   1   None    342562  5510424 0.99</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="case-3-sql-agents">Case 3: SQL agents<a href="#case-3-sql-agents" class="hash-link" aria-label="Direct link to Case 3: SQL agents" title="Direct link to Case 3: SQL agents">​</a></h2><p>LangChain has an SQL Agent which provides a more flexible way of interacting with SQL Databases than the <code>SQLDatabaseChain</code>.</p><p>The main advantages of using the SQL Agent are:</p><ul><li>It can answer questions based on the databases&#x27; schema as well as on the databases&#x27; content (like describing a specific table)</li><li>It can recover from errors by running a generated query, catching the traceback and regenerating it correctly</li></ul><p>To initialize the agent, we use <code>create_sql_agent</code> function. </p><p>This agent contains the <code>SQLDatabaseToolkit</code> which contains tools to: </p><ul><li>Create and execute queries</li><li>Check query syntax</li><li>Retrieve table descriptions</li><li>... and more</li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agents </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> create_sql_agent</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agents</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agent_toolkits </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> SQLDatabaseToolkit</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># from langchain.agents import AgentExecutor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agents</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agent_types </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> AgentType</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">db </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> SQLDatabase</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">from_uri</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;sqlite:///Chinook.db&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">llm </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> OpenAI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">temperature</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> verbose</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">agent_executor </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> create_sql_agent</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    llm</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">OpenAI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">temperature</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    toolkit</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">SQLDatabaseToolkit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">db</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> llm</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">OpenAI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">temperature</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    verbose</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    agent_type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">AgentType</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">ZERO_SHOT_REACT_DESCRIPTION</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="padding-top:1.3rem;background:var(--prism-background-color);color:var(--prism-color);margin-top:calc(-1 * var(--ifm-leading) - 5px);margin-bottom:var(--ifm-leading);box-shadow:var(--ifm-global-shadow-lw);border-bottom-left-radius:var(--ifm-code-border-radius);border-bottom-right-radius:var(--ifm-code-border-radius)"><h4 style="padding-left:0.65rem;margin-bottom:0.45rem">API Reference:</h4><ul style="padding-bottom:1rem"><li><a href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent_toolkits.sql.base.create_sql_agent.html"><span>create_sql_agent</span></a></li><li><a href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent_toolkits.sql.toolkit.SQLDatabaseToolkit.html"><span>SQLDatabaseToolkit</span></a></li><li><a href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent.AgentExecutor.html"><span>AgentExecutor</span></a></li><li><a href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent_types.AgentType.html"><span>AgentType</span></a></li></ul></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="agent-task-example-1---running-queries">Agent task example #1 - Running queries<a href="#agent-task-example-1---running-queries" class="hash-link" aria-label="Direct link to Agent task example #1 - Running queries" title="Direct link to Agent task example #1 - Running queries">​</a></h3><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">agent_executor</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;List the total sales per country. Which country&#x27;s customers spent the most?&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div lang="python"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &gt; Entering new AgentExecutor chain...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Action: sql_db_list_tables</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Action Input: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Observation: Album, Artist, Customer, Employee, Genre, Invoice, InvoiceLine, MediaType, Playlist, PlaylistTrack, Track</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Thought: I should query the schema of the Invoice and Customer tables.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Action: sql_db_schema</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Action Input: Invoice, Customer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Observation: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    CREATE TABLE &quot;Customer&quot; (</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;CustomerId&quot; INTEGER NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;FirstName&quot; NVARCHAR(40) NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;LastName&quot; NVARCHAR(20) NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Company&quot; NVARCHAR(80), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Address&quot; NVARCHAR(70), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;City&quot; NVARCHAR(40), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;State&quot; NVARCHAR(40), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Country&quot; NVARCHAR(40), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;PostalCode&quot; NVARCHAR(10), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Phone&quot; NVARCHAR(24), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Fax&quot; NVARCHAR(24), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Email&quot; NVARCHAR(60) NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;SupportRepId&quot; INTEGER, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        PRIMARY KEY (&quot;CustomerId&quot;), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        FOREIGN KEY(&quot;SupportRepId&quot;) REFERENCES &quot;Employee&quot; (&quot;EmployeeId&quot;)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    3 rows from Customer table:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    CustomerId  FirstName   LastName    Company Address City    State   Country PostalCode  Phone   Fax Email   SupportRepId</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    1   Luís    Gonçalves   Embraer - Empresa Brasileira de Aeronáutica S.A.    Av. Brigadeiro Faria Lima, 2170 São José dos Campos SP  Brazil  12227-000   +55 (12) 3923-5555  +55 (12) 3923-5566  luisg@embraer.com.br    3</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    2   Leonie  Köhler  None    Theodor-Heuss-Straße 34 Stuttgart   None    Germany 70174   +49 0711 2842222    None    leonekohler@surfeu.de   5</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    3   François    Tremblay    None    1498 rue Bélanger   Montréal    QC  Canada  H2G 1A7 +1 (514) 721-4711   None    ftremblay@gmail.com 3</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    CREATE TABLE &quot;Invoice&quot; (</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;InvoiceId&quot; INTEGER NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;CustomerId&quot; INTEGER NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;InvoiceDate&quot; DATETIME NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;BillingAddress&quot; NVARCHAR(70), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;BillingCity&quot; NVARCHAR(40), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;BillingState&quot; NVARCHAR(40), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;BillingCountry&quot; NVARCHAR(40), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;BillingPostalCode&quot; NVARCHAR(10), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Total&quot; NUMERIC(10, 2) NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        PRIMARY KEY (&quot;InvoiceId&quot;), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        FOREIGN KEY(&quot;CustomerId&quot;) REFERENCES &quot;Customer&quot; (&quot;CustomerId&quot;)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    3 rows from Invoice table:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    InvoiceId   CustomerId  InvoiceDate BillingAddress  BillingCity BillingState    BillingCountry  BillingPostalCode   Total</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    1   2   2009-01-01 00:00:00 Theodor-Heuss-Straße 34 Stuttgart   None    Germany 70174   1.98</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    2   4   2009-01-02 00:00:00 Ullevålsveien 14    Oslo    None    Norway  0171    3.96</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    3   8   2009-01-03 00:00:00 Grétrystraat 63 Brussels    None    Belgium 1000    5.94</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Thought: I should query the total sales per country.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Action: sql_db_query</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Action Input: SELECT Country, SUM(Total) AS TotalSales FROM Invoice INNER JOIN Customer ON Invoice.CustomerId = Customer.CustomerId GROUP BY Country ORDER BY TotalSales DESC LIMIT 10</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Observation: [(&#x27;USA&#x27;, 523.0600000000003), (&#x27;Canada&#x27;, 303.9599999999999), (&#x27;France&#x27;, 195.09999999999994), (&#x27;Brazil&#x27;, 190.09999999999997), (&#x27;Germany&#x27;, 156.48), (&#x27;United Kingdom&#x27;, 112.85999999999999), (&#x27;Czech Republic&#x27;, 90.24000000000001), (&#x27;Portugal&#x27;, 77.23999999999998), (&#x27;India&#x27;, 75.25999999999999), (&#x27;Chile&#x27;, 46.62)]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Thought: I now know the final answer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Final Answer: The country with the highest total sales is the USA, with a total of $523.06.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &gt; Finished chain.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &#x27;The country with the highest total sales is the USA, with a total of $523.06.&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><p>Looking at the <a href="https://smith.langchain.com/public/a86dbe17-5782-4020-bce6-2de85343168a/r" target="_blank" rel="noopener noreferrer">LangSmith trace</a>, we can see:</p><ul><li>The agent is using a ReAct style prompt</li><li>First, it will look at the tables: <code>Action: sql_db_list_tables</code> using tool <code>sql_db_list_tables</code></li><li>Given the tables as an observation, it <code>thinks</code> and then determinates the next <code>action</code>:</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">Observation: Album, Artist, Customer, Employee, Genre, Invoice, InvoiceLine, MediaType, Playlist, PlaylistTrack, Track</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Thought: I should query the schema of the Invoice and Customer tables.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Action: sql_db_schema</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Action Input: Invoice, Customer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>It then formulates the query using the schema from tool <code>sql_db_schema</code></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">Thought: I should query the total sales per country.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Action: sql_db_query</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Action Input: SELECT Country, SUM(Total) AS TotalSales FROM Invoice INNER JOIN Customer ON Invoice.CustomerId = Customer.CustomerId GROUP BY Country ORDER BY TotalSales DESC LIMIT 10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>It finally executes the generated query using tool <code>sql_db_query</code></li></ul><p><img loading="lazy" alt="sql_usecase.png" src="/langchain/assets/images/SQLDatabaseToolkit-e91acbc75814721926cf1bb972f77adb.png" width="3317" height="1116" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="agent-task-example-2---describing-a-table">Agent task example #2 - Describing a Table<a href="#agent-task-example-2---describing-a-table" class="hash-link" aria-label="Direct link to Agent task example #2 - Describing a Table" title="Direct link to Agent task example #2 - Describing a Table">​</a></h3><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">agent_executor</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Describe the playlisttrack table&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div lang="python"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &gt; Entering new AgentExecutor chain...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Action: sql_db_list_tables</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Action Input: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Observation: Album, Artist, Customer, Employee, Genre, Invoice, InvoiceLine, MediaType, Playlist, PlaylistTrack, Track</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Thought: The PlaylistTrack table is the most relevant to the question.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Action: sql_db_schema</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Action Input: PlaylistTrack</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Observation: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    CREATE TABLE &quot;PlaylistTrack&quot; (</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;PlaylistId&quot; INTEGER NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;TrackId&quot; INTEGER NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        PRIMARY KEY (&quot;PlaylistId&quot;, &quot;TrackId&quot;), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        FOREIGN KEY(&quot;TrackId&quot;) REFERENCES &quot;Track&quot; (&quot;TrackId&quot;), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        FOREIGN KEY(&quot;PlaylistId&quot;) REFERENCES &quot;Playlist&quot; (&quot;PlaylistId&quot;)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    3 rows from PlaylistTrack table:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    PlaylistId  TrackId</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    1   3402</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    1   3389</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    1   3390</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Thought: I now know the final answer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Final Answer: The PlaylistTrack table contains two columns, PlaylistId and TrackId, which are both integers and form a primary key. It also has two foreign keys, one to the Track table and one to the Playlist table.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &gt; Finished chain.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &#x27;The PlaylistTrack table contains two columns, PlaylistId and TrackId, which are both integers and form a primary key. It also has two foreign keys, one to the Track table and one to the Playlist table.&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="extending-the-sql-toolkit">Extending the SQL Toolkit<a href="#extending-the-sql-toolkit" class="hash-link" aria-label="Direct link to Extending the SQL Toolkit" title="Direct link to Extending the SQL Toolkit">​</a></h3><p>Although the out-of-the-box SQL Toolkit contains the necessary tools to start working on a database, it is often the case that some extra tools may be useful for extending the agent&#x27;s capabilities. This is particularly useful when trying to use <strong>domain specific knowledge</strong> in the solution, in order to improve its overall performance.</p><p>Some examples include:</p><ul><li>Including dynamic few shot examples</li><li>Finding misspellings in proper nouns to use as column filters</li></ul><p>We can create separate tools which tackle these specific use cases and include them as a complement to the standard SQL Toolkit. Let&#x27;s see how to include these two custom tools.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="including-dynamic-few-shot-examples">Including dynamic few-shot examples<a href="#including-dynamic-few-shot-examples" class="hash-link" aria-label="Direct link to Including dynamic few-shot examples" title="Direct link to Including dynamic few-shot examples">​</a></h4><p>In order to include dynamic few-shot examples, we need a custom <strong>Retriever Tool</strong> that handles the vector database in order to retrieve the examples that are semantically similar to the user’s question.</p><p>Let&#x27;s start by creating a dictionary with some examples: </p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># few_shots = {&#x27;List all artists.&#x27;: &#x27;SELECT * FROM artists;&#x27;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#              &quot;Find all albums for the artist &#x27;AC/DC&#x27;.&quot;: &quot;SELECT * FROM albums WHERE ArtistId = (SELECT ArtistId FROM artists WHERE Name = &#x27;AC/DC&#x27;);&quot;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#              &quot;List all tracks in the &#x27;Rock&#x27; genre.&quot;: &quot;SELECT * FROM tracks WHERE GenreId = (SELECT GenreId FROM genres WHERE Name = &#x27;Rock&#x27;);&quot;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#              &#x27;Find the total duration of all tracks.&#x27;: &#x27;SELECT SUM(Milliseconds) FROM tracks;&#x27;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#              &#x27;List all customers from Canada.&#x27;: &quot;SELECT * FROM customers WHERE Country = &#x27;Canada&#x27;;&quot;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#              &#x27;How many tracks are there in the album with ID 5?&#x27;: &#x27;SELECT COUNT(*) FROM tracks WHERE AlbumId = 5;&#x27;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#              &#x27;Find the total number of invoices.&#x27;: &#x27;SELECT COUNT(*) FROM invoices;&#x27;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#              &#x27;List all tracks that are longer than 5 minutes.&#x27;: &#x27;SELECT * FROM tracks WHERE Milliseconds &gt; 300000;&#x27;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#              &#x27;Who are the top 5 customers by total purchase?&#x27;: &#x27;SELECT CustomerId, SUM(Total) AS TotalPurchase FROM invoices GROUP BY CustomerId ORDER BY TotalPurchase DESC LIMIT 5;&#x27;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#              &#x27;Which albums are from the year 2000?&#x27;: &quot;SELECT * FROM albums WHERE strftime(&#x27;%Y&#x27;, ReleaseDate) = &#x27;2000&#x27;;&quot;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#              &#x27;How many employees are there&#x27;: &#x27;SELECT COUNT(*) FROM &quot;employee&quot;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#             }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can then create a retriever using the list of questions, assigning the target SQL query as metadata:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">embeddings</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">openai </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> OpenAIEmbeddings</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">vectorstores </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> FAISS</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">schema </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> Document</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">embeddings </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> OpenAIEmbeddings</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">few_shot_docs </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Document</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">page_content</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">question</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> metadata</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;sql_query&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> few_shots</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">question</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> question </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> few_shots</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">keys</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">vector_db </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> FAISS</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">from_documents</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">few_shot_docs</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> embeddings</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">retriever </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> vector_db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">as_retriever</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="padding-top:1.3rem;background:var(--prism-background-color);color:var(--prism-color);margin-top:calc(-1 * var(--ifm-leading) - 5px);margin-bottom:var(--ifm-leading);box-shadow:var(--ifm-global-shadow-lw);border-bottom-left-radius:var(--ifm-code-border-radius);border-bottom-right-radius:var(--ifm-code-border-radius)"><h4 style="padding-left:0.65rem;margin-bottom:0.45rem">API Reference:</h4><ul style="padding-bottom:1rem"><li><a href="https://api.python.langchain.com/en/latest/embeddings/langchain.embeddings.openai.OpenAIEmbeddings.html"><span>OpenAIEmbeddings</span></a></li><li><a href="https://api.python.langchain.com/en/latest/vectorstores/langchain.vectorstores.faiss.FAISS.html"><span>FAISS</span></a></li><li><a href="https://api.python.langchain.com/en/latest/schema/langchain.schema.document.Document.html"><span>Document</span></a></li></ul></div><p>Now we can create our own custom tool and append it as a new tool in the <code>create_sql_agent</code> function:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agents</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agent_toolkits </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> create_retriever_tool</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tool_description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">This tool will help you understand similar examples to adapt them to the user question.</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Input to this tool should be the user question.</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">retriever_tool </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> create_retriever_tool</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        retriever</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        name</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;sql_get_similar_examples&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        description</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">tool_description</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">custom_tool_list </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">retriever_tool</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="padding-top:1.3rem;background:var(--prism-background-color);color:var(--prism-color);margin-top:calc(-1 * var(--ifm-leading) - 5px);margin-bottom:var(--ifm-leading);box-shadow:var(--ifm-global-shadow-lw);border-bottom-left-radius:var(--ifm-code-border-radius);border-bottom-right-radius:var(--ifm-code-border-radius)"><h4 style="padding-left:0.65rem;margin-bottom:0.45rem">API Reference:</h4><ul style="padding-bottom:1rem"><li><a href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent_toolkits.conversational_retrieval.tool.create_retriever_tool.html"><span>create_retriever_tool</span></a></li></ul></div><p>Now we can create the agent, adjusting the standard SQL Agent suffix to consider our use case. Although the most straightforward way to handle this would be to include it just in the tool description, this is often not enough and we need to specify it in the agent prompt using the <code>suffix</code> argument in the constructor.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agents </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> create_sql_agent</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> AgentType</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agents</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agent_toolkits </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> SQLDatabaseToolkit</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">utilities </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> SQLDatabase</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">chat_models </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> ChatOpenAI</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">db </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> SQLDatabase</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">from_uri</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;sqlite:///Chinook.db&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">llm </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> ChatOpenAI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">model_name</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;gpt-4&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain">temperature</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">toolkit </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> SQLDatabaseToolkit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">db</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> llm</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">custom_suffix </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">I should first get the similar examples I know.</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">If the examples are enough to construct the query, I can build it.</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Otherwise, I can then look at the tables in the database to see what I can query.</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Then I should query the schema of the most relevant tables</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">agent </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> create_sql_agent</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">llm</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         toolkit</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">toolkit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         verbose</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         agent_type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">AgentType</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">OPENAI_FUNCTIONS</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         extra_tools</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">custom_tool_list</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         suffix</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">custom_suffix</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="padding-top:1.3rem;background:var(--prism-background-color);color:var(--prism-color);margin-top:calc(-1 * var(--ifm-leading) - 5px);margin-bottom:var(--ifm-leading);box-shadow:var(--ifm-global-shadow-lw);border-bottom-left-radius:var(--ifm-code-border-radius);border-bottom-right-radius:var(--ifm-code-border-radius)"><h4 style="padding-left:0.65rem;margin-bottom:0.45rem">API Reference:</h4><ul style="padding-bottom:1rem"><li><a href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent_toolkits.sql.base.create_sql_agent.html"><span>create_sql_agent</span></a></li><li><a href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent_types.AgentType.html"><span>AgentType</span></a></li><li><a href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent_toolkits.sql.toolkit.SQLDatabaseToolkit.html"><span>SQLDatabaseToolkit</span></a></li><li><a href="https://api.python.langchain.com/en/latest/utilities/langchain.utilities.sql_database.SQLDatabase.html"><span>SQLDatabase</span></a></li><li><a href="https://api.python.langchain.com/en/latest/chat_models/langchain.chat_models.openai.ChatOpenAI.html"><span>ChatOpenAI</span></a></li></ul></div><p>Let&#x27;s try it out:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">agent</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;How many employees do we have?&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div lang="python"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &gt; Entering new AgentExecutor chain...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Invoking: `sql_get_similar_examples` with `How many employees do we have?`</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    [Document(page_content=&#x27;How many employees are there&#x27;, metadata={&#x27;sql_query&#x27;: &#x27;SELECT COUNT(*) FROM &quot;employee&quot;&#x27;}), Document(page_content=&#x27;Find the total number of invoices.&#x27;, metadata={&#x27;sql_query&#x27;: &#x27;SELECT COUNT(*) FROM invoices;&#x27;})]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Invoking: `sql_db_query_checker` with `SELECT COUNT(*) FROM employee`</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    responded: {content}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    SELECT COUNT(*) FROM employee</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Invoking: `sql_db_query` with `SELECT COUNT(*) FROM employee`</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    [(8,)]We have 8 employees.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &gt; Finished chain.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &#x27;We have 8 employees.&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><p>As we can see, the agent first used the <code>sql_get_similar_examples</code> tool in order to retrieve similar examples. As the question was very similar to other few shot examples, the agent <strong>didn&#x27;t need to use any other tool</strong> from the standard Toolkit, thus <strong>saving time and tokens</strong>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="finding-and-correcting-misspellings-for-proper-nouns">Finding and correcting misspellings for proper nouns<a href="#finding-and-correcting-misspellings-for-proper-nouns" class="hash-link" aria-label="Direct link to Finding and correcting misspellings for proper nouns" title="Direct link to Finding and correcting misspellings for proper nouns">​</a></h4><p>In order to filter columns that contain proper nouns such as addresses, song names or artists, we first need to double-check the spelling in order to filter the data correctly. </p><p>We can achieve this by creating a vector store using all the distinct proper nouns that exist in the database. We can then have the agent query that vector store each time the user includes a proper noun in their question, to find the correct spelling for that word. In this way, the agent can make sure it understands which entity the user is referring to before building the target query.</p><p>Let&#x27;s follow a similar approach to the few shots, but without metadata: just embedding the proper nouns and then querying to get the most similar one to the misspelled user question.</p><p>First we need the unique values for each entity we want, for which we define a function that parses the result into a list of elements:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> ast</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> re</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">run_query_save_results</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> query</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    res </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    res </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">el </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> sub </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> ast</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">literal_eval</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">res</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> el </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> sub </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> el</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    res </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">re</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">sub</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">r&#x27;\b\d+\b&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> string </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">return</span><span class="token plain"> res</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">artists </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> run_query_save_results</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SELECT Name FROM Artist&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">albums </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> run_query_save_results</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SELECT Title FROM Album&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we can proceed with creating the custom <strong>retreiver tool</strong> and the final agent:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agents</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agent_toolkits </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> create_retriever_tool</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">embeddings</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">openai </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> OpenAIEmbeddings</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">vectorstores </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> FAISS</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">texts </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">artists </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> albums</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">embeddings </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> OpenAIEmbeddings</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">vector_db </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> FAISS</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">from_texts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">texts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> embeddings</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">retriever </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> vector_db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">as_retriever</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">retriever_tool </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> create_retriever_tool</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        retriever</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        name</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;name_search&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        description</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;use to learn how a piece of data is actually written, can be from names, surnames addresses etc&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">custom_tool_list </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">retriever_tool</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="padding-top:1.3rem;background:var(--prism-background-color);color:var(--prism-color);margin-top:calc(-1 * var(--ifm-leading) - 5px);margin-bottom:var(--ifm-leading);box-shadow:var(--ifm-global-shadow-lw);border-bottom-left-radius:var(--ifm-code-border-radius);border-bottom-right-radius:var(--ifm-code-border-radius)"><h4 style="padding-left:0.65rem;margin-bottom:0.45rem">API Reference:</h4><ul style="padding-bottom:1rem"><li><a href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent_toolkits.conversational_retrieval.tool.create_retriever_tool.html"><span>create_retriever_tool</span></a></li><li><a href="https://api.python.langchain.com/en/latest/embeddings/langchain.embeddings.openai.OpenAIEmbeddings.html"><span>OpenAIEmbeddings</span></a></li><li><a href="https://api.python.langchain.com/en/latest/vectorstores/langchain.vectorstores.faiss.FAISS.html"><span>FAISS</span></a></li></ul></div><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agents </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> create_sql_agent</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> AgentType</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agents</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">agent_toolkits </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> SQLDatabaseToolkit</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">utilities </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> SQLDatabase</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">chat_models </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> ChatOpenAI</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># db = SQLDatabase.from_uri(&quot;sqlite:///Chinook.db&quot;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">llm </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> ChatOpenAI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">model_name</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;gpt-4&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> temperature</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">toolkit </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> SQLDatabaseToolkit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">db</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> llm</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">custom_suffix </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">If a user asks for me to filter based on proper nouns, I should first check the spelling using the name_search tool.</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Otherwise, I can then look at the tables in the database to see what I can query.</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Then I should query the schema of the most relevant tables</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">agent </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> create_sql_agent</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">llm</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         toolkit</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">toolkit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         verbose</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         agent_type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">AgentType</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">OPENAI_FUNCTIONS</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         extra_tools</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">custom_tool_list</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         suffix</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">custom_suffix</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="padding-top:1.3rem;background:var(--prism-background-color);color:var(--prism-color);margin-top:calc(-1 * var(--ifm-leading) - 5px);margin-bottom:var(--ifm-leading);box-shadow:var(--ifm-global-shadow-lw);border-bottom-left-radius:var(--ifm-code-border-radius);border-bottom-right-radius:var(--ifm-code-border-radius)"><h4 style="padding-left:0.65rem;margin-bottom:0.45rem">API Reference:</h4><ul style="padding-bottom:1rem"><li><a href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent_toolkits.sql.base.create_sql_agent.html"><span>create_sql_agent</span></a></li><li><a href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent_types.AgentType.html"><span>AgentType</span></a></li><li><a href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent_toolkits.sql.toolkit.SQLDatabaseToolkit.html"><span>SQLDatabaseToolkit</span></a></li><li><a href="https://api.python.langchain.com/en/latest/utilities/langchain.utilities.sql_database.SQLDatabase.html"><span>SQLDatabase</span></a></li><li><a href="https://api.python.langchain.com/en/latest/chat_models/langchain.chat_models.openai.ChatOpenAI.html"><span>ChatOpenAI</span></a></li></ul></div><p>Let&#x27;s try it out:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">agent</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;How many albums does alis in pains have?&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div lang="python"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &gt; Entering new AgentExecutor chain...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Invoking: `name_search` with `alis in pains`</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    [Document(page_content=&#x27;House of Pain&#x27;, metadata={}), Document(page_content=&#x27;Alice In Chains&#x27;, metadata={}), Document(page_content=&#x27;Aisha Duo&#x27;, metadata={}), Document(page_content=&#x27;House Of Pain&#x27;, metadata={})]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Invoking: `sql_db_list_tables` with ``</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    responded: {content}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Album, Artist, Customer, Employee, Genre, Invoice, InvoiceLine, MediaType, Playlist, PlaylistTrack, Track</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Invoking: `sql_db_schema` with `Album, Artist`</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    responded: {content}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    CREATE TABLE &quot;Album&quot; (</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;AlbumId&quot; INTEGER NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Title&quot; NVARCHAR(160) NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;ArtistId&quot; INTEGER NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        PRIMARY KEY (&quot;AlbumId&quot;), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        FOREIGN KEY(&quot;ArtistId&quot;) REFERENCES &quot;Artist&quot; (&quot;ArtistId&quot;)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    3 rows from Album table:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    AlbumId Title   ArtistId</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    1   For Those About To Rock We Salute You   1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    2   Balls to the Wall   2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    3   Restless and Wild   2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    CREATE TABLE &quot;Artist&quot; (</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;ArtistId&quot; INTEGER NOT NULL, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        &quot;Name&quot; NVARCHAR(120), </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        PRIMARY KEY (&quot;ArtistId&quot;)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    3 rows from Artist table:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ArtistId    Name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    1   AC/DC</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    2   Accept</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    3   Aerosmith</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Invoking: `sql_db_query_checker` with `SELECT COUNT(*) FROM Album JOIN Artist ON Album.ArtistId = Artist.ArtistId WHERE Artist.Name = &#x27;Alice In Chains&#x27;`</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    responded: {content}</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    SELECT COUNT(*) FROM Album JOIN Artist ON Album.ArtistId = Artist.ArtistId WHERE Artist.Name = &#x27;Alice In Chains&#x27;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Invoking: `sql_db_query` with `SELECT COUNT(*) FROM Album JOIN Artist ON Album.ArtistId = Artist.ArtistId WHERE Artist.Name = &#x27;Alice In Chains&#x27;`</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    [(1,)]Alice In Chains has 1 album in the database.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &gt; Finished chain.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    &#x27;Alice In Chains has 1 album in the database.&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><p>As we can see, the agent used the <code>name_search</code> tool in order to check how to correctly query the database for this specific artist.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="go-deeper-3">Go deeper<a href="#go-deeper-3" class="hash-link" aria-label="Direct link to Go deeper" title="Direct link to Go deeper">​</a></h3><p>To learn more about the SQL Agent and how it works we refer to the <a href="/langchain/docs/integrations/toolkits/sql_database">SQL Agent Toolkit</a> documentation.</p><p>You can also check Agents for other document types:</p><ul><li><a href="/langchain/docs/integrations/toolkits/pandas.html">Pandas Agent</a></li><li><a href="/langchain/docs/integrations/toolkits/csv.html">CSV Agent</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="elastic-search">Elastic Search<a href="#elastic-search" class="hash-link" aria-label="Direct link to Elastic Search" title="Direct link to Elastic Search">​</a></h2><p>Going beyond the above use-case, there are integrations with other databases.</p><p>For example, we can interact with Elasticsearch analytics database. </p><p>This chain builds search queries via the Elasticsearch DSL API (filters and aggregations).</p><p>The Elasticsearch client must have permissions for index listing, mapping description and search queries.</p><p>See <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html" target="_blank" rel="noopener noreferrer">here</a> for instructions on how to run Elasticsearch locally.</p><p>Make sure to install the Elasticsearch Python client before:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">pip install elasticsearch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> elasticsearch </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> Elasticsearch</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">chat_models </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> ChatOpenAI</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">chains</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">elasticsearch_database </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> ElasticsearchDatabaseChain</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="padding-top:1.3rem;background:var(--prism-background-color);color:var(--prism-color);margin-top:calc(-1 * var(--ifm-leading) - 5px);margin-bottom:var(--ifm-leading);box-shadow:var(--ifm-global-shadow-lw);border-bottom-left-radius:var(--ifm-code-border-radius);border-bottom-right-radius:var(--ifm-code-border-radius)"><h4 style="padding-left:0.65rem;margin-bottom:0.45rem">API Reference:</h4><ul style="padding-bottom:1rem"><li><a href="https://api.python.langchain.com/en/latest/chat_models/langchain.chat_models.openai.ChatOpenAI.html"><span>ChatOpenAI</span></a></li><li><a href="https://api.python.langchain.com/en/latest/chains/langchain.chains.elasticsearch_database.base.ElasticsearchDatabaseChain.html"><span>ElasticsearchDatabaseChain</span></a></li></ul></div><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Initialize Elasticsearch python client.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># See https://elasticsearch-py.readthedocs.io/en/v8.8.2/api.html#elasticsearch.Elasticsearch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ELASTIC_SEARCH_SERVER </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;https://elastic:pass@localhost:9200&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">db </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Elasticsearch</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">ELASTIC_SEARCH_SERVER</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Uncomment the next cell to initially populate your db.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># customers = [</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#     {&quot;firstname&quot;: &quot;Jennifer&quot;, &quot;lastname&quot;: &quot;Walters&quot;},</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#     {&quot;firstname&quot;: &quot;Monica&quot;,&quot;lastname&quot;:&quot;Rambeau&quot;},</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#     {&quot;firstname&quot;: &quot;Carol&quot;,&quot;lastname&quot;:&quot;Danvers&quot;},</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#     {&quot;firstname&quot;: &quot;Wanda&quot;,&quot;lastname&quot;:&quot;Maximoff&quot;},</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#     {&quot;firstname&quot;: &quot;Jennifer&quot;,&quot;lastname&quot;:&quot;Takeda&quot;},</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># ]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># for i, customer in enumerate(customers):</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#     db.create(index=&quot;customers&quot;, document=customer, id=i)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">llm </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> ChatOpenAI</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">model_name</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;gpt-4&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> temperature</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">chain </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> ElasticsearchDatabaseChain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">from_llm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">llm</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> database</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> verbose</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">question </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;What are the first names of all the customers?&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">chain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">question</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can customize the prompt.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#F5F5F5"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">chains</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">elasticsearch_database</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">prompts </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> DEFAULT_DSL_TEMPLATE</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">prompts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">prompt </span><span class="token keyword" style="color:rgb(0, 0, 255)">import</span><span class="token plain"> PromptTemplate</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PROMPT_TEMPLATE </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">&quot;&quot;&quot;Given an input question, create a syntactically correct Elasticsearch query to run. Unless the user specifies in their question a specific number of examples they wish to obtain, always limit your query to at most {top_k} results. You can order the results by a relevant column to return the most interesting examples in the database.</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Unless told to do not query for all the columns from a specific index, only ask for a the few relevant columns given the question.</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Pay attention to use only the column names that you can see in the mapping description. Be careful to not query for columns that do not exist. Also, pay attention to which column is in which index. Return the query as valid json.</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Use the following format:</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">Question: Question here</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">ESQuery: Elasticsearch Query formatted as json</span><br></span><span class="token-line" style="color:#000000"><span class="token triple-quoted-string string" style="color:rgb(163, 21, 21)">&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PROMPT </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> PromptTemplate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">from_template</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    PROMPT_TEMPLATE</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">chain </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> ElasticsearchDatabaseChain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">from_llm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">llm</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> database</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> query_prompt</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">PROMPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="padding-top:1.3rem;background:var(--prism-background-color);color:var(--prism-color);margin-top:calc(-1 * var(--ifm-leading) - 5px);margin-bottom:var(--ifm-leading);box-shadow:var(--ifm-global-shadow-lw);border-bottom-left-radius:var(--ifm-code-border-radius);border-bottom-right-radius:var(--ifm-code-border-radius)"><h4 style="padding-left:0.65rem;margin-bottom:0.45rem">API Reference:</h4><ul style="padding-bottom:1rem"><li><a href="https://api.python.langchain.com/en/latest/prompts/langchain.prompts.prompt.PromptTemplate.html"><span>PromptTemplate</span></a></li></ul></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/langchain/docs/use_cases/question_answering/integrations/semantic-search-over-chat"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">QA using Activeloop&#x27;s DeepLake</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/langchain/docs/use_cases/qa_structured/integrations/elasticsearch"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Elasticsearch</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#use-case" class="table-of-contents__link toc-highlight">Use case</a></li><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#quickstart" class="table-of-contents__link toc-highlight">Quickstart</a><ul><li><a href="#go-deeper" class="table-of-contents__link toc-highlight">Go deeper</a></li></ul></li><li><a href="#case-1-text-to-sql-query" class="table-of-contents__link toc-highlight">Case 1: Text-to-SQL query</a><ul><li><a href="#go-deeper-1" class="table-of-contents__link toc-highlight">Go deeper</a></li></ul></li><li><a href="#case-2-text-to-sql-query-and-execution" class="table-of-contents__link toc-highlight">Case 2: Text-to-SQL query and execution</a><ul><li><a href="#go-deeper-2" class="table-of-contents__link toc-highlight">Go deeper</a></li></ul></li><li><a href="#case-3-sql-agents" class="table-of-contents__link toc-highlight">Case 3: SQL agents</a><ul><li><a href="#agent-task-example-1---running-queries" class="table-of-contents__link toc-highlight">Agent task example #1 - Running queries</a></li><li><a href="#agent-task-example-2---describing-a-table" class="table-of-contents__link toc-highlight">Agent task example #2 - Describing a Table</a></li><li><a href="#extending-the-sql-toolkit" class="table-of-contents__link toc-highlight">Extending the SQL Toolkit</a></li><li><a href="#go-deeper-3" class="table-of-contents__link toc-highlight">Go deeper</a></li></ul></li><li><a href="#elastic-search" class="table-of-contents__link toc-highlight">Elastic Search</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/cU2adEyC7w" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/LangChainAI" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">GitHub</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hwchase17/langchain" target="_blank" rel="noopener noreferrer" class="footer__link-item">Python<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/hwchase17/langchainjs" target="_blank" rel="noopener noreferrer" class="footer__link-item">JS/TS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://langchain.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Homepage<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://blog.langchain.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 LangChain, Inc.</div></div></div></footer></div>
<script src="/langchain/assets/js/runtime~main.a20b23d6.js"></script>
<script src="/langchain/assets/js/main.af9852a9.js"></script>
</body>
</html>