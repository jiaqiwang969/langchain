"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[92579],{3905:(e,n,a)=>{a.d(n,{Zo:()=>u,kt:()=>d});var t=a(67294);function r(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function s(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function o(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?s(Object(a),!0).forEach((function(n){r(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function l(e,n){if(null==e)return{};var a,t,r=function(e,n){if(null==e)return{};var a,t,r={},s=Object.keys(e);for(t=0;t<s.length;t++)a=s[t],n.indexOf(a)>=0||(r[a]=e[a]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(t=0;t<s.length;t++)a=s[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var i=t.createContext({}),p=function(e){var n=t.useContext(i),a=n;return e&&(a="function"==typeof e?e(n):o(o({},n),e)),a},u=function(e){var n=p(e.components);return t.createElement(i.Provider,{value:n},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},h=t.forwardRef((function(e,n){var a=e.components,r=e.mdxType,s=e.originalType,i=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(a),h=r,d=c["".concat(i,".").concat(h)]||c[h]||m[h]||s;return a?t.createElement(d,o(o({ref:n},u),{},{components:a})):t.createElement(d,o({ref:n},u))}));function d(e,n){var a=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var s=a.length,o=new Array(s);o[0]=h;var l={};for(var i in n)hasOwnProperty.call(n,i)&&(l[i]=n[i]);l.originalType=e,l[c]="string"==typeof e?e:r,o[1]=l;for(var p=2;p<s;p++)o[p]=a[p];return t.createElement.apply(null,o)}return t.createElement.apply(null,a)}h.displayName="MDXCreateElement"},20406:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>i,contentTitle:()=>o,default:()=>d,frontMatter:()=>s,metadata:()=>l,toc:()=>p});var t=a(87462),r=(a(67294),a(3905));const s={},o="Causal program-aided language (CPAL) chain",l={unversionedId:"use_cases/more/code_writing/cpal",id:"use_cases/more/code_writing/cpal",title:"Causal program-aided language (CPAL) chain",description:"The CPAL chain builds on the recent PAL to stop LLM hallucination. The problem with the PAL approach is that it hallucinates on a math problem with a nested chain of dependence. The innovation here is that this new CPAL approach includes causal structure to fix hallucination.",source:"@site/docs/use_cases/more/code_writing/cpal.md",sourceDirName:"use_cases/more/code_writing",slug:"/use_cases/more/code_writing/cpal",permalink:"/langchain/docs/use_cases/more/code_writing/cpal",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"use_cases",previous:{title:"Code writing",permalink:"/langchain/docs/use_cases/more/code_writing/"},next:{title:"Bash chain",permalink:"/langchain/docs/use_cases/more/code_writing/llm_bash"}},i={},p=[{value:"CPAL&#39;s value against hallucination: CPAL vs PAL",id:"cpals-value-against-hallucination-cpal-vs-pal",level:2},{value:"1.1 Complex narrative",id:"11-complex-narrative",level:3},{value:"Unanswerable math",id:"unanswerable-math",level:3},{value:"Basic math",id:"basic-math",level:3},{value:"Causal mediator",id:"causal-mediator",level:4},{value:"Causal collider",id:"causal-collider",level:3},{value:"Causal confounder",id:"causal-confounder",level:3}],u=(c="CodeOutputBlock",function(e){return console.warn("Component "+c+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.kt)("div",e)});var c;const m={toc:p},h="wrapper";function d(e){let{components:n,...s}=e;return(0,r.kt)(h,(0,t.Z)({},m,s,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"causal-program-aided-language-cpal-chain"},"Causal program-aided language (CPAL) chain"),(0,r.kt)("p",null,"The CPAL chain builds on the recent PAL to stop LLM hallucination. The problem with the PAL approach is that it hallucinates on a math problem with a nested chain of dependence. The innovation here is that this new CPAL approach includes causal structure to fix hallucination."),(0,r.kt)("p",null,"The original ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/hwchase17/langchain/pull/6255"},"PR's description")," contains a full overview."),(0,r.kt)("p",null,"Using the CPAL chain, the LLM translated this"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'"Tim buys the same number of pets as Cindy and Boris."\n"Cindy buys the same number of pets as Bill plus Bob."\n"Boris buys the same number of pets as Ben plus Beth."\n"Bill buys the same number of pets as Obama."\n"Bob buys the same number of pets as Obama."\n"Ben buys the same number of pets as Obama."\n"Beth buys the same number of pets as Obama."\n"If Obama buys one pet, how many pets total does everyone buy?"\n')),(0,r.kt)("p",null,"into this"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"complex-graph.png",src:a(79014).Z,width:"976",height:"828"}),"."),(0,r.kt)("p",null,"Outline of code examples demoed in this notebook."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"CPAL's value against hallucination: CPAL vs PAL",(0,r.kt)("br",{parentName:"li"}),"1.1 Complex narrative",(0,r.kt)("br",{parentName:"li"}),"1.2 Unanswerable math word problem  "),(0,r.kt)("li",{parentName:"ol"},"CPAL's three types of causal diagrams (",(0,r.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/The_Book_of_Why"},"The Book of Why"),").",(0,r.kt)("br",{parentName:"li"}),"2.1 Mediator",(0,r.kt)("br",{parentName:"li"}),"2.2 Collider",(0,r.kt)("br",{parentName:"li"}),"2.3 Confounder   ")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"from IPython.display import SVG\n\nfrom langchain_experimental.cpal.base import CPALChain\nfrom langchain_experimental.pal_chain import PALChain\nfrom langchain import OpenAI\n\nllm = OpenAI(temperature=0, max_tokens=512)\ncpal_chain = CPALChain.from_univariate_prompt(llm=llm, verbose=True)\npal_chain = PALChain.from_math_prompt(llm=llm, verbose=True)\n")),(0,r.kt)("h2",{id:"cpals-value-against-hallucination-cpal-vs-pal"},"CPAL's value against hallucination: CPAL vs PAL"),(0,r.kt)("p",null,"Like PAL, CPAL intends to reduce large language model (LLM) hallucination."),(0,r.kt)("p",null,"The CPAL chain is different from the PAL chain for a couple of reasons."),(0,r.kt)("p",null,"CPAL adds a causal structure (or DAG) to link entity actions (or math expressions).\nThe CPAL math expressions are modeling a chain of cause and effect relations, which can be intervened upon, whereas for the PAL chain math expressions are projected math identities."),(0,r.kt)("h3",{id:"11-complex-narrative"},"1.1 Complex narrative"),(0,r.kt)("p",null,"Takeaway: PAL hallucinates, CPAL does not hallucinate."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'question = (\n    "Tim buys the same number of pets as Cindy and Boris."\n    "Cindy buys the same number of pets as Bill plus Bob."\n    "Boris buys the same number of pets as Ben plus Beth."\n    "Bill buys the same number of pets as Obama."\n    "Bob buys the same number of pets as Obama."\n    "Ben buys the same number of pets as Obama."\n    "Beth buys the same number of pets as Obama."\n    "If Obama buys one pet, how many pets total does everyone buy?"\n)\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"pal_chain.run(question)\n")),(0,r.kt)(u,{lang:"python",mdxType:"CodeOutputBlock"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'    \n    \n    > Entering new  chain...\n    def solution():\n        """Tim buys the same number of pets as Cindy and Boris.Cindy buys the same number of pets as Bill plus Bob.Boris buys the same number of pets as Ben plus Beth.Bill buys the same number of pets as Obama.Bob buys the same number of pets as Obama.Ben buys the same number of pets as Obama.Beth buys the same number of pets as Obama.If Obama buys one pet, how many pets total does everyone buy?"""\n        obama_pets = 1\n        tim_pets = obama_pets\n        cindy_pets = obama_pets + obama_pets\n        boris_pets = obama_pets + obama_pets\n        total_pets = tim_pets + cindy_pets + boris_pets\n        result = total_pets\n        return result\n    \n    > Finished chain.\n\n\n\n\n\n    \'5\'\n'))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"cpal_chain.run(question)\n")),(0,r.kt)(u,{lang:"python",mdxType:"CodeOutputBlock"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'    \n    \n    > Entering new  chain...\n    story outcome data\n        name                                   code  value      depends_on\n    0  obama                                   pass    1.0              []\n    1   bill               bill.value = obama.value    1.0         [obama]\n    2    bob                bob.value = obama.value    1.0         [obama]\n    3    ben                ben.value = obama.value    1.0         [obama]\n    4   beth               beth.value = obama.value    1.0         [obama]\n    5  cindy   cindy.value = bill.value + bob.value    2.0     [bill, bob]\n    6  boris   boris.value = ben.value + beth.value    2.0     [ben, beth]\n    7    tim  tim.value = cindy.value + boris.value    4.0  [cindy, boris]\n    \n    query data\n    {\n        "question": "how many pets total does everyone buy?",\n        "expression": "SELECT SUM(value) FROM df",\n        "llm_error_msg": ""\n    }\n    \n    \n    > Finished chain.\n\n\n\n\n\n    13.0\n'))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'# wait 20 secs to see display\ncpal_chain.draw(path="web.svg")\nSVG("web.svg")\n')),(0,r.kt)(u,{lang:"python",mdxType:"CodeOutputBlock"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    \n![svg](_cpal_files/output_7_0.svg)\n    \n"))),(0,r.kt)("h3",{id:"unanswerable-math"},"Unanswerable math"),(0,r.kt)("p",null,"Takeaway: PAL hallucinates, where CPAL, rather than hallucinate, answers with ",(0,r.kt)("em",{parentName:"p"},'"unanswerable, narrative question and plot are incoherent"')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'question = (\n    "Jan has three times the number of pets as Marcia."\n    "Marcia has two more pets than Cindy."\n    "If Cindy has ten pets, how many pets does Barak have?"\n)\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"pal_chain.run(question)\n")),(0,r.kt)(u,{lang:"python",mdxType:"CodeOutputBlock"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'    \n    \n    > Entering new  chain...\n    def solution():\n        """Jan has three times the number of pets as Marcia.Marcia has two more pets than Cindy.If Cindy has ten pets, how many pets does Barak have?"""\n        cindy_pets = 10\n        marcia_pets = cindy_pets + 2\n        jan_pets = marcia_pets * 3\n        result = jan_pets\n        return result\n    \n    > Finished chain.\n\n\n\n\n\n    \'36\'\n'))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"try:\n    cpal_chain.run(question)\nexcept Exception as e_msg:\n    print(e_msg)\n")),(0,r.kt)(u,{lang:"python",mdxType:"CodeOutputBlock"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    \n    \n    > Entering new  chain...\n    story outcome data\n         name                            code  value depends_on\n    0   cindy                            pass   10.0         []\n    1  marcia  marcia.value = cindy.value + 2   12.0    [cindy]\n    2     jan    jan.value = marcia.value * 3   36.0   [marcia]\n    \n    query data\n    {\n        \"question\": \"how many pets does barak have?\",\n        \"expression\": \"SELECT name, value FROM df WHERE name = 'barak'\",\n        \"llm_error_msg\": \"\"\n    }\n    \n    unanswerable, query and outcome are incoherent\n    \n    outcome:\n         name                            code  value depends_on\n    0   cindy                            pass   10.0         []\n    1  marcia  marcia.value = cindy.value + 2   12.0    [cindy]\n    2     jan    jan.value = marcia.value * 3   36.0   [marcia]\n    query:\n    {'question': 'how many pets does barak have?', 'expression': \"SELECT name, value FROM df WHERE name = 'barak'\", 'llm_error_msg': ''}\n"))),(0,r.kt)("h3",{id:"basic-math"},"Basic math"),(0,r.kt)("h4",{id:"causal-mediator"},"Causal mediator"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'question = (\n    "Jan has three times the number of pets as Marcia. "\n    "Marcia has two more pets than Cindy. "\n    "If Cindy has four pets, how many total pets do the three have?"\n)\n')),(0,r.kt)("hr",null),(0,r.kt)("p",null,"PAL"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"pal_chain.run(question)\n")),(0,r.kt)(u,{lang:"python",mdxType:"CodeOutputBlock"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'    \n    \n    > Entering new  chain...\n    def solution():\n        """Jan has three times the number of pets as Marcia. Marcia has two more pets than Cindy. If Cindy has four pets, how many total pets do the three have?"""\n        cindy_pets = 4\n        marcia_pets = cindy_pets + 2\n        jan_pets = marcia_pets * 3\n        total_pets = cindy_pets + marcia_pets + jan_pets\n        result = total_pets\n        return result\n    \n    > Finished chain.\n\n\n\n\n\n    \'28\'\n'))),(0,r.kt)("hr",null),(0,r.kt)("p",null,"CPAL"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"cpal_chain.run(question)\n")),(0,r.kt)(u,{lang:"python",mdxType:"CodeOutputBlock"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'    \n    \n    > Entering new  chain...\n    story outcome data\n         name                            code  value depends_on\n    0   cindy                            pass    4.0         []\n    1  marcia  marcia.value = cindy.value + 2    6.0    [cindy]\n    2     jan    jan.value = marcia.value * 3   18.0   [marcia]\n    \n    query data\n    {\n        "question": "how many total pets do the three have?",\n        "expression": "SELECT SUM(value) FROM df",\n        "llm_error_msg": ""\n    }\n    \n    \n    > Finished chain.\n\n\n\n\n\n    28.0\n'))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'# wait 20 secs to see display\ncpal_chain.draw(path="web.svg")\nSVG("web.svg")\n')),(0,r.kt)(u,{lang:"python",mdxType:"CodeOutputBlock"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    \n![svg](_cpal_files/output_18_0.svg)\n    \n"))),(0,r.kt)("h3",{id:"causal-collider"},"Causal collider"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'question = (\n    "Jan has the number of pets as Marcia plus the number of pets as Cindy. "\n    "Marcia has no pets. "\n    "If Cindy has four pets, how many total pets do the three have?"\n)\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"cpal_chain.run(question)\n")),(0,r.kt)(u,{lang:"python",mdxType:"CodeOutputBlock"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'    \n    \n    > Entering new  chain...\n    story outcome data\n         name                                    code  value       depends_on\n    0  marcia                                    pass    0.0               []\n    1   cindy                                    pass    4.0               []\n    2     jan  jan.value = marcia.value + cindy.value    4.0  [marcia, cindy]\n    \n    query data\n    {\n        "question": "how many total pets do the three have?",\n        "expression": "SELECT SUM(value) FROM df",\n        "llm_error_msg": ""\n    }\n    \n    \n    > Finished chain.\n\n\n\n\n\n    8.0\n'))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'# wait 20 secs to see display\ncpal_chain.draw(path="web.svg")\nSVG("web.svg")\n')),(0,r.kt)(u,{lang:"python",mdxType:"CodeOutputBlock"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    \n![svg](_cpal_files/output_22_0.svg)\n    \n"))),(0,r.kt)("h3",{id:"causal-confounder"},"Causal confounder"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'question = (\n    "Jan has the number of pets as Marcia plus the number of pets as Cindy. "\n    "Marcia has two more pets than Cindy. "\n    "If Cindy has four pets, how many total pets do the three have?"\n)\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"cpal_chain.run(question)\n")),(0,r.kt)(u,{lang:"python",mdxType:"CodeOutputBlock"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'    \n    \n    > Entering new  chain...\n    story outcome data\n         name                                    code  value       depends_on\n    0   cindy                                    pass    4.0               []\n    1  marcia          marcia.value = cindy.value + 2    6.0          [cindy]\n    2     jan  jan.value = cindy.value + marcia.value   10.0  [cindy, marcia]\n    \n    query data\n    {\n        "question": "how many total pets do the three have?",\n        "expression": "SELECT SUM(value) FROM df",\n        "llm_error_msg": ""\n    }\n    \n    \n    > Finished chain.\n\n\n\n\n\n    20.0\n'))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'# wait 20 secs to see display\ncpal_chain.draw(path="web.svg")\nSVG("web.svg")\n')),(0,r.kt)(u,{lang:"python",mdxType:"CodeOutputBlock"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    \n![svg](_cpal_files/output_26_0.svg)\n    \n"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"%autoreload 2\n")))}d.isMDXComponent=!0},79014:(e,n,a)=>{a.d(n,{Z:()=>t});const t=a.p+"assets/images/cpal_diagram-49f2f4fdb38f9c646c2d650c915a1782.png"}}]);